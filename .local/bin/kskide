#!/bin/bash 

server_name=$(basename `pwd`)
socket_file=$(kak -l | grep $server_name)
window_title="Kakoune -"
join_session=false

# parse/handle args
while test $# -gt 0; do
  case "$1" in
    -h|--help)
      echo "$package - Kakoune, Sway, Kitty based IDE. Will create windows: main, docs, tools, shell"
      echo " "
      echo "$package [options]"
      echo " "
      echo "options:"
      echo "-h, --help                show brief help"
      echo "-j, --join-existing-session"
      exit 0
      ;;
    -j)
      shift
      join_session=true
      ;;
    *)
      break
      ;;
  esac
done

# create new layout using kitty and sway
createLayout() {
  kitty @ set-window-title "$window_title shell"

  # create main client
  kitty @ new-window --no-response --window-type os --title "$window_title main" kak -e "ide-set-client main jumpclient" -c $server_name

  swaymsg move left
  swaymsg "[title=\"$window_title shell\"] focus"
  swaymsg splitv

  # create docs client
  kitty @ new-window --no-response --window-type os --title "$window_title docs" kak -e "ide-set-client docs docsclient" -c $server_name

  swaymsg move up
  swaymsg "[title=\"$window_title shell\"] focus"
  swaymsg splith

  # create tools client
  kitty @ new-window --no-response --window-type os --title "$window_title tools" kak -e "ide-set-client tools toolsclient" -c $server_name

  swaymsg move left
  swaymsg layout tabbed

  # set focus on main client
  swaymsg "[title=\"$window_title main\"] focus"
}

# handle basic command logic
if [[ $socket_file == "" ]]; then
  # start daemon & set term title
  setsid kak -d -s $server_name &
  createLayout
elif [[ $socket_file != "" && $join_session == true ]]; then
  createLayout
else
  echo "Session \"$server_name\" already exists."
  echo "To join this session use the -j parameter: 'kskide -j'"
  exit 1
fi
