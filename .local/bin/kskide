#!/bin/bash
#
# this is a very CRUDE start
package=$(basename $0)
server_name=$(basename `pwd`)
socket_file=$(kak -l | grep $server_name)
window_title="$server_name </>"
join_session=false

# project & theme support
project_conf="$HOME/.config/kskide.projs"
theme_variant=$(waystep kak)
theme_file="$HOME/.config/rofi/theme/$theme_variant.rasi"
rofi_theme_option=""
if [ -f "${theme_file}" ]; then
  rofi_theme_option="-theme $theme_file"
fi

# parse/handle args
while test $# -gt 0; do
  case "$1" in
    -p|--projects)
      # TODO: if user escapes rofi, return and end process
      selection=$(awk -F ':' '{print $1}' $project_conf | rofi -dmenu -p 'Kakoune â†’ Select Project' $rofi_theme_option)
      selection_path=$(grep $selection $project_conf | awk -F ':' '{print $2}')
      kitty @ launch --no-response --cwd $selection_path --type os-window kskide
      exit 0
      ;;
    -h|--help)
      echo "$package - Kakoune, Sway, Kitty based IDE. Will create windows: main, docs, tools, shell"
      echo " "
      echo "$package [options]"
      echo " "
      echo "options:"
      echo "-h, --help                show brief help"
      echo "-j, --join-existing-session"
      exit 0
      ;;
    -j|--join-session)
      shift
      join_session=true
      ;;
    *)
      ;;
  esac
done

# create new layout using kitty and sway
createLayout() {
  kitty @ set-window-title "$window_title xxx"
  kitty @ launch --cwd `pwd` --no-response --type os-window --title "$window_title shell"

  # # create main client
  kitty @ launch --no-response --type os-window --title "$window_title main" kak -e "ide-set-client main jumpclient" -c $server_name

  swaymsg move left
  swaymsg "[title=\"$window_title shell\"] focus"
  swaymsg splitv

  # create docs client
  kitty @ launch --no-response --type os-window --title "$window_title docs" kak -e "ide-set-client docs docsclient" -c $server_name

  swaymsg move up
  swaymsg "[title=\"$window_title shell\"] focus"
  swaymsg splith

  # create tools client
  kitty @ launch --no-response --type os-window --title "$window_title tools" kak -e "ide-set-client tools toolsclient" -c $server_name

  swaymsg move left
  swaymsg layout tabbed

  # set focus on main client
  swaymsg "[title=\"$window_title main\"] focus"
  kitty @ close-window --match title:"$window_title xxx"
}

# handle basic command logic
if [[ $socket_file == "" ]]; then
  # start daemon & set term title
  setsid kak -d -s $server_name &
  createLayout
elif [[ $socket_file != "" && $join_session == true ]]; then
  createLayout
else
  echo "To join this session use the -j parameter: 'kskide -j'"
  echo "Session \"$server_name\" already exists."
  exit 1
fi

# TODO: add to createLayout, set timeout?
# kitty @ close-window --match title:"$window_title xxx"

